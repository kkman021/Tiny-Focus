<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>TinyFocus - å°ˆæ³¨åŠ›è¨“ç·´éŠæˆ²</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    /* ========== åŸºç¤è¨­å®š ========== */
    body {
      margin: 0;
      padding: 0;
      overscroll-behavior: none;
      user-select: none;
      -webkit-user-select: none;
      font-family: 'Segoe UI Emoji', 'Apple Color Emoji', sans-serif;
    }

    ::-webkit-scrollbar {
      display: none;
    }

    /* 100dvh fallback */
    .full-height {
      height: 100vh;
      height: 100dvh;
    }

    /* ========== å‹•ç•« ========== */
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-20px); }
    }

    @keyframes bounce-in {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes pop-in {
      0% { transform: scale(0); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }

    @keyframes star-pop {
      0% { transform: scale(0) rotate(0deg); }
      50% { transform: scale(1.3) rotate(180deg); }
      100% { transform: scale(1) rotate(360deg); }
    }

    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
      50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
    }

    @keyframes slide-up {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }

    @keyframes freeze-spread {
      0% { opacity: 0; transform: scale(0.5); }
      50% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }

    @keyframes ice-shimmer {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    @keyframes crack-appear {
      0% { opacity: 0; transform: scale(0.8) rotate(0deg); }
      100% { opacity: 0.6; transform: scale(1) rotate(5deg); }
    }

    @keyframes ice-particle-float {
      0%, 100% { transform: translateY(0) scale(1); opacity: 0.8; }
      50% { transform: translateY(-5px) scale(1.2); opacity: 1; }
    }

    @keyframes gradient-shift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* ========== å‹•ç•«é¡åˆ¥ ========== */
    .animate-float { animation: float 3s ease-in-out infinite; }
    .animate-bounce-in { animation: bounce-in 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    .animate-pop-in { animation: pop-in 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55); }
    .animate-star-pop { animation: star-pop 0.5s ease-out; }
    .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
    .animate-slide-up { animation: slide-up 0.5s ease-out forwards; }
    .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
    .animate-shake { animation: shake 0.5s ease-in-out; }

    /* ========== èƒŒæ™¯è£é£¾ ========== */
    .bg-decoration {
      position: absolute;
      border-radius: 50%;
      opacity: 0.1;
      pointer-events: none;
    }

    /* ========== é¸é …å¡ç‰‡ ========== */
    .option-card {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .option-card:hover { transform: translateY(-5px); }
    .option-card.selected {
      transform: scale(1.05);
      box-shadow: 0 0 0 4px #3b82f6;
    }

    /* ========== æ»‘æ¡¿ ========== */
    input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      background: transparent;
    }
    input[type="range"]::-webkit-slider-track {
      background: #e5e7eb;
      height: 8px;
      border-radius: 4px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
      margin-top: -8px;
    }
    input[type="range"]::-moz-range-track {
      background: #e5e7eb;
      height: 8px;
      border-radius: 4px;
    }
    input[type="range"]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: #3b82f6;
      cursor: pointer;
      border: none;
    }

    /* ========== éŠæˆ²å¡ç‰‡ ========== */
    .game-card {
      aspect-ratio: 1;
      transition: all 0.3s ease;
      position: relative;
    }
    .game-card:not(:disabled):not(.frozen):hover { transform: scale(1.05); }
    .game-card:not(:disabled):not(.frozen):active { transform: scale(0.95); }
    .game-card.error {
      opacity: 0.3;
      filter: grayscale(100%);
      pointer-events: none;
    }
    .game-card.success {
      transform: scale(1.15) !important;
      box-shadow: 0 0 0 6px #4ade80;
    }
    .game-card.frozen {
      cursor: not-allowed;
      pointer-events: none;
    }

    /* ========== å†°å¡Šæ•ˆæœ ========== */
    .frozen-overlay { position: relative; }
    .frozen-overlay::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg,
        rgba(191, 219, 254, 0.9) 0%,
        rgba(219, 234, 254, 0.95) 25%,
        rgba(191, 219, 254, 0.9) 50%,
        rgba(219, 234, 254, 0.95) 75%,
        rgba(191, 219, 254, 0.9) 100%);
      background-size: 200% 200%;
      border-radius: 1rem;
      pointer-events: none;
      z-index: 1;
      animation: freeze-spread 0.3s ease-out, ice-shimmer 2s ease-in-out infinite;
      box-shadow: inset 0 0 20px rgba(147, 197, 253, 0.8),
                  inset 0 0 40px rgba(191, 219, 254, 0.6);
    }
    .frozen-overlay::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(45deg, transparent 48%, rgba(255, 255, 255, 0.8) 49%, rgba(255, 255, 255, 0.8) 51%, transparent 52%),
        linear-gradient(-45deg, transparent 48%, rgba(255, 255, 255, 0.6) 49%, rgba(255, 255, 255, 0.6) 51%, transparent 52%),
        linear-gradient(30deg, transparent 45%, rgba(255, 255, 255, 0.4) 48%, transparent 52%);
      border-radius: 1rem;
      pointer-events: none;
      z-index: 2;
      animation: crack-appear 0.4s ease-out 0.2s both;
    }

    /* å†°éœœç²’å­ */
    .ice-particle {
      position: absolute;
      width: 8px;
      height: 8px;
      background: radial-gradient(circle, rgba(255, 255, 255, 0.9) 0%, rgba(191, 219, 254, 0.6) 100%);
      border-radius: 50%;
      pointer-events: none;
      z-index: 3;
      animation: ice-particle-float 1.5s ease-in-out infinite;
    }

    /* ========== æ…¶ç¥èƒŒæ™¯ ========== */
    .celebration-bg {
      background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 25%, #ec4899 50%, #a855f7 75%, #3b82f6 100%);
      background-size: 400% 400%;
      animation: gradient-shift 3s ease infinite;
    }

    /* éš±è— */
    .hidden { display: none !important; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-100 to-pink-100 overflow-hidden">

  <!-- ==================== èƒŒæ™¯è£é£¾ ==================== -->
  <div class="bg-decoration w-64 h-64 bg-blue-400 top-10 left-10 animate-float"></div>
  <div class="bg-decoration w-96 h-96 bg-purple-400 bottom-20 right-20 animate-float" style="animation-delay: 1s;"></div>
  <div class="bg-decoration w-48 h-48 bg-pink-400 top-1/2 right-10 animate-float" style="animation-delay: 2s;"></div>

  <!-- ==================== é¦–é ç•«é¢ ==================== -->
  <div id="homeScreen" class="full-height flex items-center justify-center p-8">
    <div class="text-center space-y-12">

      <!-- Logo èˆ‡æ¨™é¡Œ -->
      <div class="animate-bounce-in">
        <div class="text-9xl mb-6 animate-float">ğŸ¯</div>
        <h1 class="text-7xl md:text-8xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 via-purple-600 to-pink-600 mb-4">
          TinyFocus
        </h1>
        <p class="text-2xl md:text-3xl text-gray-700 font-medium">å°ˆæ³¨åŠ›è¨“ç·´éŠæˆ²</p>
      </div>

      <!-- æŒ‰éˆ•çµ„ -->
      <div class="space-y-6 animate-slide-up" style="animation-delay: 0.3s;">
        <button
          onclick="startGame()"
          class="w-full max-w-md px-16 py-8 text-4xl md:text-5xl font-bold text-white bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500 rounded-3xl shadow-2xl hover:shadow-3xl transform hover:scale-105 active:scale-95 transition-all animate-pulse-glow"
        >
          é–‹å§‹éŠæˆ² ğŸš€
        </button>

        <button
          onclick="showSettings()"
          class="w-full max-w-md px-12 py-6 text-2xl md:text-3xl font-bold text-gray-700 bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 transition-all"
        >
          éŠæˆ²è¨­å®š âš™ï¸
        </button>
      </div>

      <!-- ç‰ˆæœ¬è³‡è¨Š -->
      <div class="text-gray-600 text-sm animate-slide-up" style="animation-delay: 0.5s;">
        <p>TinyFocus v1.0 | å°ˆç‚º 2-5 æ­²å¹¼å…’è¨­è¨ˆ</p>
      </div>

    </div>
  </div>

  <!-- ==================== è¨­å®šé¢æ¿ ==================== -->
  <div id="settingsPanel" class="fixed inset-0 bg-gradient-to-br from-blue-100 via-purple-100 to-pink-100 z-50 hidden overflow-y-auto">

    <!-- è¿”å›æŒ‰éˆ• -->
    <div class="absolute top-6 left-6 z-10">
      <button
        onclick="closeSettings()"
        class="px-6 py-3 text-xl font-bold text-gray-700 bg-white/80 backdrop-blur-sm rounded-2xl shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 transition-all"
      >
        â† è¿”å›
      </button>
    </div>

    <!-- è¨­å®šå…§å®¹ -->
    <div class="min-h-full flex items-center justify-center p-6 py-20">
      <div class="w-full max-w-2xl">

        <!-- æ¨™é¡Œ -->
        <div class="text-center mb-8">
          <h2 class="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 mb-2">
            éŠæˆ²è¨­å®š
          </h2>
          <p class="text-gray-600 text-lg">è‡ªè¨‚ä½ çš„éŠæˆ²é«”é©—</p>
        </div>

        <!-- è¨­å®šå¡ç‰‡ -->
        <div class="space-y-6">

          <!-- é›£åº¦è¨­å®š -->
          <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span>ğŸ®</span>
              <span>é¸æ“‡é›£åº¦</span>
            </h3>
            <div class="grid grid-cols-3 gap-3">
              <div
                class="option-card bg-gradient-to-br from-blue-100 to-blue-200 rounded-2xl p-5 text-center selected"
                data-mode="2x2"
                onclick="selectMode('2x2')"
              >
                <div class="text-4xl mb-2">ğŸŸ¦</div>
                <div class="text-xl font-bold text-blue-800 mb-1">2 Ã— 2</div>
                <div class="text-xs text-blue-600">ç°¡å–®</div>
                <div class="text-xs text-gray-600 mt-1">4 æ ¼</div>
              </div>
              <div
                class="option-card bg-gradient-to-br from-purple-100 to-purple-200 rounded-2xl p-5 text-center"
                data-mode="3x3"
                onclick="selectMode('3x3')"
              >
                <div class="text-4xl mb-2">ğŸŸª</div>
                <div class="text-xl font-bold text-purple-800 mb-1">3 Ã— 3</div>
                <div class="text-xs text-purple-600">å›°é›£</div>
                <div class="text-xs text-gray-600 mt-1">9 æ ¼</div>
              </div>
              <div
                class="option-card bg-gradient-to-br from-red-100 to-red-200 rounded-2xl p-5 text-center"
                data-mode="4x4"
                onclick="selectMode('4x4')"
              >
                <div class="text-4xl mb-2">ğŸŸ¥</div>
                <div class="text-xl font-bold text-red-800 mb-1">4 Ã— 4</div>
                <div class="text-xs text-red-600">æŒ‘æˆ°</div>
                <div class="text-xs text-gray-600 mt-1">16 æ ¼</div>
              </div>
            </div>
          </div>

          <!-- ä¸»é¡Œè¨­å®š -->
          <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-2 flex items-center gap-2">
              <span>ğŸ¨</span>
              <span>é¸æ“‡ä¸»é¡Œ</span>
            </h3>
            <p class="text-sm text-gray-500 mb-4">å¯å¤šé¸ä¸»é¡Œæ··åˆå‡ºé¡Œï¼Œæˆ–é¸æ“‡ã€Œæ··åˆã€è‡ªå‹•çµ„åˆ</p>
            <div class="grid grid-cols-3 gap-3">
              <div class="option-card bg-gradient-to-br from-green-100 to-green-200 rounded-2xl p-4 text-center selected" data-category="animals" onclick="selectCategory('animals')">
                <div class="text-3xl mb-1">ğŸ¦</div>
                <div class="text-xs font-bold text-green-800">å‹•ç‰©</div>
              </div>
              <div class="option-card bg-gradient-to-br from-red-100 to-red-200 rounded-2xl p-4 text-center" data-category="fruits" onclick="selectCategory('fruits')">
                <div class="text-3xl mb-1">ğŸ</div>
                <div class="text-xs font-bold text-red-800">æ°´æœ</div>
              </div>
              <div class="option-card bg-gradient-to-br from-blue-100 to-blue-200 rounded-2xl p-4 text-center" data-category="vehicles" onclick="selectCategory('vehicles')">
                <div class="text-3xl mb-1">ğŸš—</div>
                <div class="text-xs font-bold text-blue-800">äº¤é€š</div>
              </div>
              <div class="option-card bg-gradient-to-br from-yellow-100 to-yellow-200 rounded-2xl p-4 text-center" data-category="numbers" onclick="selectCategory('numbers')">
                <div class="text-3xl mb-1">ğŸ”¢</div>
                <div class="text-xs font-bold text-yellow-800">æ•¸å­—</div>
              </div>
              <div class="option-card bg-gradient-to-br from-pink-100 to-pink-200 rounded-2xl p-4 text-center" data-category="shapes" onclick="selectCategory('shapes')">
                <div class="text-3xl mb-1">â­</div>
                <div class="text-xs font-bold text-pink-800">å½¢ç‹€</div>
              </div>
              <div class="option-card bg-gradient-to-br from-cyan-100 to-cyan-200 rounded-2xl p-4 text-center" data-category="letters" onclick="selectCategory('letters')">
                <div class="text-3xl mb-1 font-bold text-cyan-600">ABC</div>
                <div class="text-xs font-bold text-cyan-800">å­—æ¯</div>
              </div>
              <div class="option-card bg-gradient-to-br from-orange-100 to-orange-200 rounded-2xl p-4 text-center" data-category="zhuyin" onclick="selectCategory('zhuyin')">
                <div class="text-3xl mb-1 font-bold text-orange-600">ã„…ã„†</div>
                <div class="text-xs font-bold text-orange-800">æ³¨éŸ³</div>
              </div>
              <div class="option-card bg-gradient-to-br from-indigo-100 to-indigo-200 rounded-2xl p-4 text-center col-span-2" data-category="mixed" onclick="selectCategory('mixed')">
                <div class="text-3xl mb-1">ğŸ²</div>
                <div class="text-xs font-bold text-indigo-800">æ··åˆ</div>
              </div>
            </div>
          </div>

          <!-- é¡Œæ•¸è¨­å®š -->
          <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span>ğŸ“Š</span>
              <span>é¡Œç›®æ•¸é‡</span>
            </h3>
            <div>
              <label class="block text-lg font-medium text-gray-700 mb-3 text-center">
                <span id="roundsValue" class="text-4xl text-blue-600 font-bold">10</span> é¡Œ
              </label>
              <input
                id="roundsSlider"
                type="range"
                min="5"
                max="20"
                step="5"
                value="10"
                class="w-full"
                oninput="updateRounds(this.value)"
              />
              <div class="flex justify-between text-sm text-gray-500 mt-2">
                <span>5 é¡Œ</span>
                <span>10 é¡Œ</span>
                <span>15 é¡Œ</span>
                <span>20 é¡Œ</span>
              </div>
            </div>
          </div>

          <!-- èªéŸ³è¨­å®š -->
          <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span>ğŸ”Š</span>
              <span>èªéŸ³è§’è‰²</span>
            </h3>
            <div class="grid grid-cols-3 gap-3">
              <div
                class="option-card bg-gradient-to-br from-gray-100 to-gray-200 rounded-2xl p-5 text-center"
                data-voice="robot"
                onclick="selectVoice('robot')"
              >
                <div class="text-4xl mb-2">ğŸ¤–</div>
                <div class="text-sm font-bold text-gray-800">æ©Ÿå™¨äºº</div>
                <div class="text-xs text-gray-500 mt-1">ä½æ²‰ç©©é‡</div>
              </div>
              <div
                class="option-card bg-gradient-to-br from-blue-100 to-blue-200 rounded-2xl p-5 text-center selected"
                data-voice="normal"
                onclick="selectVoice('normal')"
              >
                <div class="text-4xl mb-2">ğŸ‘©â€ğŸ«</div>
                <div class="text-sm font-bold text-blue-800">æº«æŸ”è€å¸«</div>
                <div class="text-xs text-gray-500 mt-1">æ¨™æº–èªèª¿</div>
              </div>
              <div
                class="option-card bg-gradient-to-br from-orange-100 to-orange-200 rounded-2xl p-5 text-center"
                data-voice="cheerful"
                onclick="selectVoice('cheerful')"
              >
                <div class="text-4xl mb-2">ğŸ§’</div>
                <div class="text-sm font-bold text-orange-800">æ´»æ½‘å¤¥ä¼´</div>
                <div class="text-xs text-gray-500 mt-1">å…ƒæ°£æ»¿æ»¿</div>
              </div>
            </div>
            <button
              onclick="testVoice()"
              class="w-full mt-4 py-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white text-lg font-bold rounded-xl hover:from-blue-600 hover:to-purple-600 transition-all shadow-lg hover:shadow-xl"
            >
              ğŸ”Š è©¦è½èªéŸ³
            </button>
          </div>

          <!-- å…¶ä»–è¨­å®š -->
          <div class="bg-white/90 backdrop-blur-sm rounded-3xl shadow-xl p-6">
            <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span>ğŸ›ï¸</span>
              <span>å…¶ä»–è¨­å®š</span>
            </h3>
            <div class="space-y-4">
              <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                <div class="flex items-center gap-3">
                  <span class="text-3xl">ğŸ””</span>
                  <div>
                    <div class="font-bold text-gray-800 text-lg">éŸ³æ•ˆæç¤º</div>
                    <div class="text-sm text-gray-600">ç­”é¡Œæ™‚çš„éŸ³æ•ˆå›é¥‹</div>
                  </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="sfxToggle" class="sr-only peer" checked onchange="toggleSfx()">
                  <div class="w-14 h-8 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-6 peer-checked:after:border-white after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
              </div>
              <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                <div class="flex items-center gap-3">
                  <span class="text-3xl">ğŸ“³</span>
                  <div>
                    <div class="font-bold text-gray-800 text-lg">æŒ¯å‹•å›é¥‹</div>
                    <div class="text-sm text-gray-600">ç­”éŒ¯æ™‚çš„æŒ¯å‹•æç¤º</div>
                  </div>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="vibrationToggle" class="sr-only peer" checked onchange="toggleVibration()">
                  <div class="w-14 h-8 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-6 peer-checked:after:border-white after:content-[''] after:absolute after:top-1 after:left-1 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-blue-600"></div>
                </label>
              </div>
            </div>
          </div>

        </div>

        <!-- å®ŒæˆæŒ‰éˆ• -->
        <div class="mt-8">
          <button
            onclick="closeSettings()"
            class="w-full py-6 text-3xl font-bold text-white bg-gradient-to-r from-green-500 to-emerald-500 rounded-3xl shadow-2xl hover:shadow-3xl transform hover:scale-105 active:scale-95 transition-all"
          >
            å®Œæˆè¨­å®š âœ“
          </button>
        </div>

      </div>
    </div>
  </div>

  <!-- ==================== éŠæˆ²ç•«é¢ ==================== -->
  <div id="gameScreen" class="full-height flex flex-col hidden">

    <!-- æ¨™é¡Œåˆ— -->
    <header class="bg-white shadow-md p-4 flex items-center justify-between relative z-10">
      <!-- è¿”å›é¦–é æŒ‰éˆ• -->
      <button
        onclick="confirmBackToHome()"
        class="px-4 py-2 text-lg font-bold text-gray-700 bg-gray-100 rounded-xl hover:bg-gray-200 active:scale-95 transition-all"
      >
        ğŸ 
      </button>
      
      <!-- ç›®æ¨™åœ–ç¤º -->
      <div class="flex-1 flex justify-center">
        <span id="targetIcon" class="text-5xl animate-bounce-in">ğŸ¦</span>
      </div>
      
      <!-- ä½”ä½å…ƒç´ ä¿æŒå°ç¨± -->
      <div class="w-16"></div>
    </header>

    <!-- æ˜Ÿæ˜Ÿé€²åº¦æ¢ -->
    <div class="bg-gradient-to-r from-blue-50 via-purple-50 to-pink-50 shadow-md px-6 py-4">
      <div class="bg-white/60 backdrop-blur-sm rounded-2xl px-4 py-3 shadow-inner">
        <div id="starsContainer" class="flex justify-center gap-3 flex-wrap"></div>
      </div>
    </div>

    <!-- éŠæˆ²å€åŸŸ -->
    <main class="flex-1 flex items-center justify-center px-6 py-8 overflow-hidden relative">
      <div id="gridBoard" class="grid gap-4 w-full max-w-2xl relative z-10"></div>
    </main>

    <!-- åº•éƒ¨è³‡è¨Š -->
    <footer class="bg-white shadow-md p-4">
      <div class="flex items-center justify-center gap-4 text-lg">
        <div class="text-gray-600">
          ç¬¬ <span id="currentRound" class="text-2xl font-bold text-blue-600">1</span>
          / <span id="totalRounds" class="font-bold">10</span> é¡Œ
        </div>
      </div>
    </footer>
  </div>

  <!-- ==================== æ…¶ç¥ç•«é¢ (å¤§) ==================== -->
  <div id="celebrationBig" class="fixed inset-0 celebration-bg flex items-center justify-center z-50 hidden">
    <div class="text-center text-white">
      <div class="text-9xl mb-8 animate-bounce-in">ğŸ†</div>
      <h2 class="text-6xl md:text-7xl font-bold mb-4 animate-pop-in" style="animation-delay: 0.2s;">å®Œç¾ï¼</h2>
      <p class="text-3xl md:text-4xl animate-pop-in" style="animation-delay: 0.4s;">ä¸€æ¬¡å°±ç­”å°ï¼</p>
    </div>
  </div>

  <!-- ==================== æ…¶ç¥ç•«é¢ (ä¸­) ==================== -->
  <div id="celebrationMedium" class="fixed inset-0 bg-gradient-to-br from-green-400 to-blue-400 flex items-center justify-center z-50 hidden">
    <div class="text-center text-white">
      <div class="text-8xl mb-6 animate-bounce-in">ğŸ‰</div>
      <h2 class="text-5xl md:text-6xl font-bold mb-4 animate-pop-in" style="animation-delay: 0.2s;">å¤ªæ£’äº†ï¼</h2>
      <p class="text-2xl md:text-3xl animate-pop-in" style="animation-delay: 0.4s;">ç­”å°äº†ï¼</p>
    </div>
  </div>

  <!-- ==================== æ…¶ç¥ç•«é¢ (ç°¡) ==================== -->
  <div id="celebrationSimple" class="fixed inset-0 bg-blue-500/90 flex items-center justify-center z-50 hidden">
    <div class="text-center text-white">
      <div class="text-7xl mb-4 animate-bounce-in">âœ“</div>
      <h2 class="text-4xl md:text-5xl font-bold animate-pop-in">ç­”å°äº†</h2>
    </div>
  </div>

  <!-- ==================== éŠæˆ²çµæŸç•«é¢ ==================== -->
  <div id="endGameOverlay" class="fixed inset-0 bg-gradient-to-br from-blue-500 via-purple-500 to-pink-500 flex items-center justify-center z-50 hidden">
    <div class="text-center text-white p-8">
      <div class="text-9xl mb-8 animate-bounce-in">ğŸ†</div>
      <h2 class="text-6xl md:text-7xl font-bold mb-6">éŠæˆ²çµæŸï¼</h2>
      <div class="bg-white/20 backdrop-blur-sm rounded-3xl p-8 mb-8">
        <p class="text-2xl mb-4">ä½ çš„æˆç¸¾ï¼š</p>
        <div class="flex justify-center gap-8 text-5xl mb-4">
          <div class="flex flex-col items-center">
            <span id="goldStarsCount" class="font-bold">0</span>
            <span class="text-3xl">â­</span>
          </div>
          <div class="flex flex-col items-center">
            <span id="silverStarsCount" class="font-bold">0</span>
            <span class="text-3xl">ğŸŒŸ</span>
          </div>
        </div>
        <p id="scoreMessage" class="text-xl"></p>
      </div>
      <div class="space-y-4">
        <button
          onclick="restartGame()"
          class="w-full px-12 py-6 text-3xl font-bold bg-white text-purple-600 rounded-3xl shadow-2xl hover:shadow-3xl transform hover:scale-105 active:scale-95 transition-all"
        >
          å†ç©ä¸€æ¬¡ ğŸ”„
        </button>
        <button
          onclick="backToHome()"
          class="w-full px-12 py-6 text-2xl font-bold bg-white/20 backdrop-blur-sm text-white rounded-2xl hover:bg-white/30 transition-all"
        >
          è¿”å›é¦–é  ğŸ 
        </button>
      </div>
    </div>
  </div>

  <script>
    // ==================== é¡Œåº«è³‡æ–™ ====================
    const itemDatabase = {
      animals: [
        { id: 'lion', icon: 'ğŸ¦', name: 'ç…å­' },
        { id: 'tiger', icon: 'ğŸ¯', name: 'è€è™' },
        { id: 'elephant', icon: 'ğŸ˜', name: 'å¤§è±¡' },
        { id: 'monkey', icon: 'ğŸµ', name: 'çŒ´å­' },
        { id: 'panda', icon: 'ğŸ¼', name: 'ç†Šè²“' },
        { id: 'dog', icon: 'ğŸ¶', name: 'ç‹—ç‹—' },
        { id: 'cat', icon: 'ğŸ±', name: 'è²“å’ª' },
        { id: 'rabbit', icon: 'ğŸ°', name: 'å…”å­' },
        { id: 'bear', icon: 'ğŸ»', name: 'ç†Š' },
        { id: 'fox', icon: 'ğŸ¦Š', name: 'ç‹ç‹¸' },
        { id: 'koala', icon: 'ğŸ¨', name: 'ç„¡å°¾ç†Š' },
        { id: 'pig', icon: 'ğŸ·', name: 'è±¬' },
        { id: 'penguin', icon: 'ğŸ§', name: 'ä¼éµ' },
        { id: 'cow', icon: 'ğŸ®', name: 'ç‰›' },
        { id: 'mouse', icon: 'ğŸ­', name: 'è€é¼ ' },
        { id: 'frog', icon: 'ğŸ¸', name: 'é’è›™' },
        { id: 'chicken', icon: 'ğŸ”', name: 'é›' },
        { id: 'duck', icon: 'ğŸ¦†', name: 'é´¨å­' },
        { id: 'owl', icon: 'ğŸ¦‰', name: 'è²“é ­é·¹' },
        { id: 'whale', icon: 'ğŸ‹', name: 'é¯¨é­š' }
      ],
      fruits: [
        { id: 'apple', icon: 'ğŸ', name: 'è˜‹æœ' },
        { id: 'banana', icon: 'ğŸŒ', name: 'é¦™è•‰' },
        { id: 'orange', icon: 'ğŸŠ', name: 'æ©˜å­' },
        { id: 'grape', icon: 'ğŸ‡', name: 'è‘¡è„' },
        { id: 'watermelon', icon: 'ğŸ‰', name: 'è¥¿ç“œ' },
        { id: 'strawberry', icon: 'ğŸ“', name: 'è‰è“' },
        { id: 'peach', icon: 'ğŸ‘', name: 'æ¡ƒå­' },
        { id: 'pineapple', icon: 'ğŸ', name: 'é³³æ¢¨' },
        { id: 'lemon', icon: 'ğŸ‹', name: 'æª¸æª¬' },
        { id: 'cherry', icon: 'ğŸ’', name: 'æ«»æ¡ƒ' },
        { id: 'kiwi', icon: 'ğŸ¥', name: 'å¥‡ç•°æœ' },
        { id: 'mango', icon: 'ğŸ¥­', name: 'èŠ’æœ' },
        { id: 'coconut', icon: 'ğŸ¥¥', name: 'æ¤°å­' },
        { id: 'avocado', icon: 'ğŸ¥‘', name: 'é…ªæ¢¨' },
        { id: 'blueberry', icon: 'ğŸ«', name: 'è—è“' },
        { id: 'melon', icon: 'ğŸˆ', name: 'å“ˆå¯†ç“œ' },
        { id: 'pear', icon: 'ğŸ', name: 'æ¢¨å­' },
        { id: 'greenapple', icon: 'ğŸ', name: 'é’è˜‹æœ' },
        { id: 'tomato', icon: 'ğŸ…', name: 'ç•ªèŒ„' },
        { id: 'corn', icon: 'ğŸŒ½', name: 'ç‰ç±³' }
      ],
      vehicles: [
        { id: 'car', icon: 'ğŸš—', name: 'æ±½è»Š' },
        { id: 'bus', icon: 'ğŸšŒ', name: 'å…¬è»Š' },
        { id: 'train', icon: 'ğŸš‚', name: 'ç«è»Š' },
        { id: 'plane', icon: 'âœˆï¸', name: 'é£›æ©Ÿ' },
        { id: 'ship', icon: 'ğŸš¢', name: 'èˆ¹' },
        { id: 'bike', icon: 'ğŸš²', name: 'è…³è¸è»Š' },
        { id: 'truck', icon: 'ğŸšš', name: 'å¡è»Š' },
        { id: 'taxi', icon: 'ğŸš•', name: 'è¨ˆç¨‹è»Š' },
        { id: 'rocket', icon: 'ğŸš€', name: 'ç«ç®­' },
        { id: 'helicopter', icon: 'ğŸš', name: 'ç›´å‡æ©Ÿ' },
        { id: 'ambulance', icon: 'ğŸš‘', name: 'æ•‘è­·è»Š' },
        { id: 'police', icon: 'ğŸš“', name: 'è­¦è»Š' },
        { id: 'motorcycle', icon: 'ğŸï¸', name: 'æ©Ÿè»Š' },
        { id: 'firetruck', icon: 'ğŸš’', name: 'æ¶ˆé˜²è»Š' },
        { id: 'tractor', icon: 'ğŸšœ', name: 'æ‹–æ‹‰æ©Ÿ' },
        { id: 'sailboat', icon: 'â›µ', name: 'å¸†èˆ¹' },
        { id: 'metro', icon: 'ğŸš‡', name: 'æ·é‹' },
        { id: 'scooter', icon: 'ğŸ›´', name: 'æ»‘æ¿è»Š' },
        { id: 'cablecar', icon: 'ğŸš¡', name: 'çºœè»Š' },
        { id: 'skateboard', icon: 'ğŸ›¹', name: 'æ»‘æ¿' }
      ],
      numbers: [
        { id: 'one', icon: '1ï¸âƒ£', name: 'ä¸€' },
        { id: 'two', icon: '2ï¸âƒ£', name: 'äºŒ' },
        { id: 'three', icon: '3ï¸âƒ£', name: 'ä¸‰' },
        { id: 'four', icon: '4ï¸âƒ£', name: 'å››' },
        { id: 'five', icon: '5ï¸âƒ£', name: 'äº”' },
        { id: 'six', icon: '6ï¸âƒ£', name: 'å…­' },
        { id: 'seven', icon: '7ï¸âƒ£', name: 'ä¸ƒ' },
        { id: 'eight', icon: '8ï¸âƒ£', name: 'å…«' },
        { id: 'nine', icon: '9ï¸âƒ£', name: 'ä¹' },
        { id: 'ten', icon: 'ğŸ”Ÿ', name: 'å' },
        { id: 'eleven', icon: '11', name: 'åä¸€', isText: true },
        { id: 'twelve', icon: '12', name: 'åäºŒ', isText: true },
        { id: 'thirteen', icon: '13', name: 'åä¸‰', isText: true },
        { id: 'fourteen', icon: '14', name: 'åå››', isText: true },
        { id: 'fifteen', icon: '15', name: 'åäº”', isText: true },
        { id: 'sixteen', icon: '16', name: 'åå…­', isText: true },
        { id: 'seventeen', icon: '17', name: 'åä¸ƒ', isText: true },
        { id: 'eighteen', icon: '18', name: 'åå…«', isText: true },
        { id: 'nineteen', icon: '19', name: 'åä¹', isText: true },
        { id: 'twenty', icon: '20', name: 'äºŒå', isText: true }
      ],
      shapes: [
        { id: 'circle', icon: 'ğŸ”µ', name: 'åœ“å½¢' },
        { id: 'square', icon: 'ğŸŸ¦', name: 'æ–¹å½¢' },
        { id: 'triangle', icon: 'ğŸ”º', name: 'ä¸‰è§’å½¢' },
        { id: 'star', icon: 'â­', name: 'æ˜Ÿæ˜Ÿ' },
        { id: 'heart', icon: 'â¤ï¸', name: 'æ„›å¿ƒ' },
        { id: 'diamond', icon: 'ğŸ’', name: 'é‘½çŸ³' },
        { id: 'moon', icon: 'ğŸŒ™', name: 'æœˆäº®' },
        { id: 'sun', icon: 'â˜€ï¸', name: 'å¤ªé™½' },
        { id: 'cloud', icon: 'â˜ï¸', name: 'é›²æœµ' },
        { id: 'rainbow', icon: 'ğŸŒˆ', name: 'å½©è™¹' },
        { id: 'snowflake', icon: 'â„ï¸', name: 'é›ªèŠ±' },
        { id: 'fire', icon: 'ğŸ”¥', name: 'ç«ç„°' },
        { id: 'droplet', icon: 'ğŸ’§', name: 'æ°´æ»´' },
        { id: 'lightning', icon: 'âš¡', name: 'é–ƒé›»' },
        { id: 'sparkle', icon: 'âœ¨', name: 'é–ƒäº®' },
        { id: 'pinkheart', icon: 'ğŸ’–', name: 'ç²‰ç´…æ„›å¿ƒ' }
      ],
      letters: [
        { id: 'a', icon: 'A', name: 'A', isText: true },
        { id: 'b', icon: 'B', name: 'B', isText: true },
        { id: 'c', icon: 'C', name: 'C', isText: true },
        { id: 'd', icon: 'D', name: 'D', isText: true },
        { id: 'e', icon: 'E', name: 'E', isText: true },
        { id: 'f', icon: 'F', name: 'F', isText: true },
        { id: 'g', icon: 'G', name: 'G', isText: true },
        { id: 'h', icon: 'H', name: 'H', isText: true },
        { id: 'i', icon: 'I', name: 'I', isText: true },
        { id: 'j', icon: 'J', name: 'J', isText: true },
        { id: 'k', icon: 'K', name: 'K', isText: true },
        { id: 'l', icon: 'L', name: 'L', isText: true },
        { id: 'm', icon: 'M', name: 'M', isText: true },
        { id: 'n', icon: 'N', name: 'N', isText: true },
        { id: 'o', icon: 'O', name: 'O', isText: true },
        { id: 'p', icon: 'P', name: 'P', isText: true },
        { id: 'q', icon: 'Q', name: 'Q', isText: true },
        { id: 'r', icon: 'R', name: 'R', isText: true },
        { id: 's', icon: 'S', name: 'S', isText: true },
        { id: 't', icon: 'T', name: 'T', isText: true },
        { id: 'u', icon: 'U', name: 'U', isText: true },
        { id: 'v', icon: 'V', name: 'V', isText: true },
        { id: 'w', icon: 'W', name: 'W', isText: true },
        { id: 'x', icon: 'X', name: 'X', isText: true },
        { id: 'y', icon: 'Y', name: 'Y', isText: true },
        { id: 'z', icon: 'Z', name: 'Z', isText: true }
      ],
      zhuyin: [
        // è²æ¯ (21å€‹)
        { id: 'b', icon: 'ã„…', name: 'ã„…', isText: true },
        { id: 'p', icon: 'ã„†', name: 'ã„†', isText: true },
        { id: 'm', icon: 'ã„‡', name: 'ã„‡', isText: true },
        { id: 'f', icon: 'ã„ˆ', name: 'ã„ˆ', isText: true },
        { id: 'd', icon: 'ã„‰', name: 'ã„‰', isText: true },
        { id: 't', icon: 'ã„Š', name: 'ã„Š', isText: true },
        { id: 'n', icon: 'ã„‹', name: 'ã„‹', isText: true },
        { id: 'l', icon: 'ã„Œ', name: 'ã„Œ', isText: true },
        { id: 'g', icon: 'ã„', name: 'ã„', isText: true },
        { id: 'k', icon: 'ã„', name: 'ã„', isText: true },
        { id: 'h', icon: 'ã„', name: 'ã„', isText: true },
        { id: 'j', icon: 'ã„', name: 'ã„', isText: true },
        { id: 'q', icon: 'ã„‘', name: 'ã„‘', isText: true },
        { id: 'x', icon: 'ã„’', name: 'ã„’', isText: true },
        { id: 'zh', icon: 'ã„“', name: 'ã„“', isText: true },
        { id: 'ch', icon: 'ã„”', name: 'ã„”', isText: true },
        { id: 'sh', icon: 'ã„•', name: 'ã„•', isText: true },
        { id: 'r', icon: 'ã„–', name: 'ã„–', isText: true },
        { id: 'z', icon: 'ã„—', name: 'ã„—', isText: true },
        { id: 'c', icon: 'ã„˜', name: 'ã„˜', isText: true },
        { id: 's', icon: 'ã„™', name: 'ã„™', isText: true },
        // éŸ»æ¯ (16å€‹)
        { id: 'a', icon: 'ã„š', name: 'ã„š', isText: true },
        { id: 'o', icon: 'ã„›', name: 'ã„›', isText: true },
        { id: 'e', icon: 'ã„œ', name: 'ã„œ', isText: true },
        { id: 'eh', icon: 'ã„', name: 'ã„', isText: true },
        { id: 'ai', icon: 'ã„', name: 'ã„', isText: true },
        { id: 'ei', icon: 'ã„Ÿ', name: 'ã„Ÿ', isText: true },
        { id: 'ao', icon: 'ã„ ', name: 'ã„ ', isText: true },
        { id: 'ou', icon: 'ã„¡', name: 'ã„¡', isText: true },
        { id: 'an', icon: 'ã„¢', name: 'ã„¢', isText: true },
        { id: 'en', icon: 'ã„£', name: 'ã„£', isText: true },
        { id: 'ang', icon: 'ã„¤', name: 'ã„¤', isText: true },
        { id: 'eng', icon: 'ã„¥', name: 'ã„¥', isText: true },
        { id: 'er', icon: 'ã„¦', name: 'ã„¦', isText: true },
        { id: 'yi', icon: 'ã„§', name: 'ã„§', isText: true },
        { id: 'wu', icon: 'ã„¨', name: 'ã„¨', isText: true },
        { id: 'yu', icon: 'ã„©', name: 'ã„©', isText: true }
      ],
      mixed: []
    };

    // ==================== èªéŸ³è§’è‰²è¨­å®š ====================
    const voiceProfiles = {
      robot: { pitch: 0.6, rate: 0.8, name: 'æ©Ÿå™¨äºº', icon: 'ğŸ¤–' },
      normal: { pitch: 1.0, rate: 0.9, name: 'æº«æŸ”è€å¸«', icon: 'ğŸ‘©â€ğŸ«' },
      cheerful: { pitch: 1.3, rate: 1.1, name: 'æ´»æ½‘å¤¥ä¼´', icon: 'ğŸ§’' }
    };

    // ==================== éŠæˆ²è¨­å®š ====================
    const gameConfig = {
      mode: '2x2',
      categories: ['animals'],  // æ”¯æ´å¤šé¸ï¼Œmixed é™¤å¤–
      rounds: 10,
      voiceType: 'normal',
      sfxEnabled: true,
      vibrationEnabled: true
    };

    // ==================== éŠæˆ²ç‹€æ…‹ ====================
    const gameState = {
      currentRound: 0,
      totalRounds: 10,
      stars: [],
      mistakeCount: 0,
      isFrozen: false,
      currentTarget: null,
      currentOptions: [],
      usedTargets: [],
      questionPool: [],
      currentItems: []  // ç•¶å‰éŠæˆ²ä½¿ç”¨çš„é¡Œç›®é›†åˆ
    };

    // ==================== è¼”åŠ©å‡½æ•¸ ====================
    function shuffleArray(array) {
      const arr = [...array];
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    // ==================== ç•«é¢åˆ‡æ› ====================
    function showScreen(screenId) {
      document.getElementById('homeScreen').classList.add('hidden');
      document.getElementById('settingsPanel').classList.add('hidden');
      document.getElementById('gameScreen').classList.add('hidden');
      document.getElementById(screenId).classList.remove('hidden');
    }

    // ==================== è¨­å®šé¢æ¿ ====================
    function showSettings() {
      showScreen('settingsPanel');
    }

    function closeSettings() {
      showScreen('homeScreen');
      saveConfig();
    }

    function selectMode(mode) {
      gameConfig.mode = mode;
      document.querySelectorAll('[data-mode]').forEach(card => {
        card.classList.toggle('selected', card.dataset.mode === mode);
      });
    }

    function selectCategory(category) {
      if (category === 'mixed') {
        // æ··åˆæ¨¡å¼ï¼šå–®é¸ï¼Œæ¸…é™¤å…¶ä»–é¸æ“‡
        gameConfig.categories = ['mixed'];
      } else {
        // éæ··åˆæ¨¡å¼ï¼šå¤šé¸åˆ‡æ›
        // å¦‚æœç›®å‰æ˜¯æ··åˆï¼Œå…ˆæ¸…ç©º
        if (gameConfig.categories.includes('mixed')) {
          gameConfig.categories = [];
        }

        const index = gameConfig.categories.indexOf(category);
        if (index > -1) {
          // å·²é¸ä¸­ï¼Œå–æ¶ˆé¸æ“‡ï¼ˆä½†è‡³å°‘ä¿ç•™ä¸€å€‹ï¼‰
          if (gameConfig.categories.length > 1) {
            gameConfig.categories.splice(index, 1);
          }
        } else {
          // æœªé¸ä¸­ï¼ŒåŠ å…¥é¸æ“‡
          gameConfig.categories.push(category);
        }
      }

      // æ›´æ–° UI
      document.querySelectorAll('[data-category]').forEach(card => {
        card.classList.toggle('selected', gameConfig.categories.includes(card.dataset.category));
      });
    }

    function updateRounds(value) {
      gameConfig.rounds = parseInt(value);
      document.getElementById('roundsValue').textContent = value;
    }

    function selectVoice(voiceType, silent = false) {
      gameConfig.voiceType = voiceType;
      document.querySelectorAll('[data-voice]').forEach(card => {
        card.classList.toggle('selected', card.dataset.voice === voiceType);
      });
      if (!silent) {
        const profile = voiceProfiles[voiceType];
        speak(`æˆ‘æ˜¯${profile.name}ï¼Œå¾ˆé«˜èˆˆèªè­˜ä½ ï¼`);
      }
    }

    function toggleSfx() {
      gameConfig.sfxEnabled = document.getElementById('sfxToggle').checked;
    }

    function toggleVibration() {
      gameConfig.vibrationEnabled = document.getElementById('vibrationToggle').checked;
      if (gameConfig.vibrationEnabled && 'vibrate' in navigator) navigator.vibrate(50);
    }

    function testVoice() {
      const profile = voiceProfiles[gameConfig.voiceType];
      speak(`ä½ å¥½ï¼æˆ‘æ˜¯${profile.name}ã€‚é€™æ˜¯èªéŸ³æ¸¬è©¦ã€‚æº–å‚™å¥½é–‹å§‹éŠæˆ²äº†å—ï¼Ÿ`);
    }

    function saveConfig() {
      localStorage.setItem('tinyFocusConfig', JSON.stringify(gameConfig));
    }

    function loadConfig() {
      const saved = localStorage.getItem('tinyFocusConfig');
      if (saved) {
        try {
          const parsed = JSON.parse(saved);

          // å‘ä¸‹ç›¸å®¹ï¼šèˆŠç‰ˆ category è½‰æ›ç‚º categories é™£åˆ—
          if (parsed.category && !parsed.categories) {
            parsed.categories = [parsed.category];
            delete parsed.category;
          }

          Object.assign(gameConfig, parsed);
          document.getElementById('roundsSlider').value = gameConfig.rounds;
          document.getElementById('roundsValue').textContent = gameConfig.rounds;
          document.getElementById('sfxToggle').checked = gameConfig.sfxEnabled;
          document.getElementById('vibrationToggle').checked = gameConfig.vibrationEnabled;
          selectMode(gameConfig.mode);

          // æ›´æ–°é¡åˆ¥ UI
          document.querySelectorAll('[data-category]').forEach(card => {
            card.classList.toggle('selected', gameConfig.categories.includes(card.dataset.category));
          });

          selectVoice(gameConfig.voiceType || 'normal', true);
        } catch (e) {
          console.error('è¼‰å…¥è¨­å®šå¤±æ•—:', e);
        }
      }
    }

    // ==================== éŠæˆ²é‚è¼¯ ====================
    function initQuestionPool() {
      const categories = gameConfig.categories;
      const gridSize = gameConfig.mode === '2x2' ? 4 : gameConfig.mode === '3x3' ? 9 : 16;

      // è‹¥ç‚ºæ··åˆé¡åˆ¥ï¼Œå…ˆåˆå§‹åŒ–
      if (categories.includes('mixed')) {
        initMixedCategory();
        gameState.currentItems = itemDatabase.mixed;
      } else {
        // åˆä½µå¤šå€‹é¡åˆ¥çš„é¡Œç›®
        gameState.currentItems = categories.flatMap(cat => itemDatabase[cat]);
      }

      // é¡Œåº«ä¸è¶³æª¢æŸ¥
      if (gameState.currentItems.length < gridSize) {
        const catNames = categories.join(', ');
        alert(`é¡Œåº«ä¸è¶³ï¼å·²é¸é¡åˆ¥å…± ${gameState.currentItems.length} å€‹é …ç›®ï¼Œä½† ${gameConfig.mode} æ¨¡å¼éœ€è¦è‡³å°‘ ${gridSize} å€‹ã€‚è«‹å¢åŠ ä¸»é¡Œæˆ–é™ä½é›£åº¦ã€‚`);
        return false;
      }

      // æ´—ç‰Œé¡Œåº«ä½œç‚ºç›®æ¨™æ± 
      gameState.questionPool = shuffleArray(gameState.currentItems);
      gameState.usedTargets = [];
      return true;
    }

    function initMixedCategory() {
      const categories = ['animals', 'fruits', 'vehicles', 'shapes', 'letters', 'zhuyin'];
      const itemsPerCategory = 4;
      itemDatabase.mixed = categories.flatMap(cat =>
        shuffleArray(itemDatabase[cat]).slice(0, itemsPerCategory)
      );
    }

    function startGame() {
      saveConfig();

      // åˆå§‹åŒ–é¡Œç›®æ± ï¼Œè‹¥å¤±æ•—å‰‡è¿”å›
      if (!initQuestionPool()) {
        return;
      }

      gameState.totalRounds = gameConfig.rounds;
      gameState.currentRound = 0;
      gameState.stars = [];

      document.getElementById('totalRounds').textContent = gameState.totalRounds;
      showScreen('gameScreen');
      initStars();

      speak('éŠæˆ²é–‹å§‹ï¼');
      setTimeout(() => nextQuestion(), 1000);
    }

    function initStars() {
      const container = document.getElementById('starsContainer');
      container.innerHTML = '';
      gameState.stars = [];
      for (let i = 0; i < gameState.totalRounds; i++) {
        const star = document.createElement('div');
        star.className = 'text-2xl opacity-20 transition-all';
        star.textContent = 'â­';
        container.appendChild(star);
        gameState.stars.push({ element: star, type: null });
      }
    }

    function generateQuestion() {
      const items = gameState.currentItems;
      const gridSize = gameConfig.mode === '2x2' ? 4 : gameConfig.mode === '3x3' ? 9 : 16;
      if (items.length < gridSize) return null;

      // å¾é¡Œç›®æ± å–å‡ºç›®æ¨™ï¼Œé¿å…é‡è¤‡
      let target;
      if (gameState.questionPool.length > 0) {
        target = gameState.questionPool.shift();
      } else {
        // è‹¥é¡Œç›®æ± ç”¨å®Œï¼Œé‡æ–°æ´—ç‰Œï¼ˆæ’é™¤å·²ç”¨éçš„ï¼‰
        const unused = items.filter(item => !gameState.usedTargets.includes(item.id));
        if (unused.length > 0) {
          gameState.questionPool = shuffleArray(unused);
          target = gameState.questionPool.shift();
        } else {
          // å…¨éƒ¨ç”¨å®Œï¼Œé‡æ–°é–‹å§‹
          gameState.usedTargets = [];
          gameState.questionPool = shuffleArray(items);
          target = gameState.questionPool.shift();
        }
      }

      gameState.usedTargets.push(target.id);

      // é¸æ“‡å¹²æ“¾é …ï¼ˆæ’é™¤ç›®æ¨™ï¼‰
      const distractorPool = items.filter(item => item.id !== target.id);
      const distractors = shuffleArray(distractorPool).slice(0, gridSize - 1);
      const options = shuffleArray([target, ...distractors]);

      return { target, options };
    }

    function renderGrid(options) {
      const grid = document.getElementById('gridBoard');
      const colsClass = gameConfig.mode === '2x2' ? 'grid-cols-2' :
                        gameConfig.mode === '3x3' ? 'grid-cols-3' : 'grid-cols-4';
      const gapClass = gameConfig.mode === '4x4' ? 'gap-2' : 'gap-4';
      grid.className = `grid ${gapClass} w-full max-w-2xl relative z-10 ${colsClass}`;
      grid.innerHTML = '';

      const textSize = gameConfig.mode === '4x4' ? 'text-4xl md:text-5xl' : 'text-6xl md:text-8xl';

      options.forEach((item, index) => {
        const card = document.createElement('button');
        const baseClass = `game-card bg-white rounded-2xl shadow-lg flex items-center justify-center ${textSize} animate-pop-in`;

        // è™•ç†æ–‡å­—é¡å‹é …ç›® (letters, numbers 11-20)
        if (item.isText) {
          card.className = baseClass + ' font-bold text-blue-600';
        } else {
          card.className = baseClass;
        }

        card.style.animationDelay = `${index * 0.05}s`;
        card.textContent = item.icon;
        card.dataset.id = item.id;
        card.onclick = () => handleCardClick(item, card);
        grid.appendChild(card);
      });
    }

    function nextQuestion() {
      confetti.reset();
      gameState.currentRound++;
      gameState.mistakeCount = 0;
      gameState.isFrozen = false;

      if (gameState.currentRound > gameState.totalRounds) {
        endGame();
        return;
      }

      document.getElementById('currentRound').textContent = gameState.currentRound;

      const question = generateQuestion();
      if (!question) return;

      gameState.currentTarget = question.target;
      gameState.currentOptions = question.options;

      const targetIcon = document.getElementById('targetIcon');
      targetIcon.textContent = question.target.icon;
      if (question.target.isText) {
        targetIcon.className = 'text-5xl animate-bounce-in font-bold text-blue-600';
      } else {
        targetIcon.className = 'text-5xl animate-bounce-in';
      }

      renderGrid(question.options);
      setTimeout(() => speak(`è«‹æ‰¾å‡º ${question.target.name}`), 300);
    }

    function handleCardClick(item, cardElement) {
      if (gameState.isFrozen) return;
      if (cardElement.disabled) return;
      if (cardElement.classList.contains('error')) return;

      if (item.id === gameState.currentTarget.id) {
        handleSuccess(cardElement);
      } else {
        handleError(cardElement);
      }
    }

    function handleError(cardElement) {
      gameState.mistakeCount++;
      cardElement.classList.add('error', 'animate-shake');
      cardElement.disabled = true;
      freezeAllCards();

      if (gameConfig.vibrationEnabled && 'vibrate' in navigator) navigator.vibrate(100);

      if (gameState.mistakeCount === 1) speak('é˜¿æ¯”ï¼Œä»”ç´°æ‰¾ï¼');
      else if (gameState.mistakeCount === 2) speak('ä¸è¦äº‚æŒ‰ï¼');
      else speak('æ…¢æ…¢æ‰¾ï¼');

      setTimeout(() => {
        cardElement.classList.remove('animate-shake');
        unfreezeAllCards();
      }, 1500);
    }

    function handleSuccess(cardElement) {
      gameState.isFrozen = true;
      cardElement.classList.add('success');

      const starType = gameState.mistakeCount === 0 ? 'gold' : 'silver';
      const starData = gameState.stars[gameState.currentRound - 1];
      starData.type = starType;
      starData.element.textContent = starType === 'gold' ? 'â­' : 'ğŸŒŸ';
      starData.element.classList.remove('opacity-20');
      starData.element.classList.add('animate-star-pop');

      if (gameConfig.sfxEnabled) playSfx('correct');

      if (gameState.mistakeCount === 0) {
        showCelebration('big');
        speak('å®Œç¾ï¼');
        confetti({ particleCount: 150, spread: 100, origin: { y: 0.6 }, colors: ['#fbbf24', '#f59e0b', '#ef4444', '#ec4899'] });
        setTimeout(() => {
          confetti({ particleCount: 100, angle: 60, spread: 55, origin: { x: 0 } });
          confetti({ particleCount: 100, angle: 120, spread: 55, origin: { x: 1 } });
        }, 200);
      } else if (gameState.mistakeCount <= 2) {
        showCelebration('medium');
        speak('å¤ªæ£’äº†ï¼');
        confetti({ particleCount: 80, spread: 60, origin: { y: 0.6 }, colors: ['#4ade80', '#3b82f6'] });
      } else {
        showCelebration('simple');
        speak('ç­”å°äº†');
      }

      setTimeout(() => {
        hideCelebration();
        setTimeout(() => nextQuestion(), 300);
      }, 2000);
    }

    function freezeAllCards() {
      gameState.isFrozen = true;
      document.querySelectorAll('.game-card').forEach(card => {
        card.classList.add('frozen', 'frozen-overlay');
        createIceParticles(card);
      });
    }

    function unfreezeAllCards() {
      gameState.isFrozen = false;
      document.querySelectorAll('.game-card').forEach(card => {
        if (!card.classList.contains('error')) {
          card.classList.remove('frozen', 'frozen-overlay');
          removeIceParticles(card);
        }
      });
    }

    function createIceParticles(cardElement) {
      for (let i = 0; i < 6; i++) {
        const particle = document.createElement('div');
        particle.className = 'ice-particle';
        particle.style.left = `${10 + Math.random() * 80}%`;
        particle.style.top = `${10 + Math.random() * 80}%`;
        particle.style.animationDelay = `${Math.random() * 0.5}s`;
        cardElement.appendChild(particle);
      }
    }

    function removeIceParticles(cardElement) {
      cardElement.querySelectorAll('.ice-particle').forEach(p => p.remove());
    }

    function showCelebration(type) {
      if (type === 'big') document.getElementById('celebrationBig').classList.remove('hidden');
      else if (type === 'medium') document.getElementById('celebrationMedium').classList.remove('hidden');
      else document.getElementById('celebrationSimple').classList.remove('hidden');
    }

    function hideCelebration() {
      document.getElementById('celebrationBig').classList.add('hidden');
      document.getElementById('celebrationMedium').classList.add('hidden');
      document.getElementById('celebrationSimple').classList.add('hidden');
    }

    function endGame() {
      const goldStars = gameState.stars.filter(s => s.type === 'gold').length;
      const silverStars = gameState.stars.filter(s => s.type === 'silver').length;

      document.getElementById('goldStarsCount').textContent = goldStars;
      document.getElementById('silverStarsCount').textContent = silverStars;

      const percentage = (goldStars / gameState.totalRounds) * 100;
      let message = '';
      if (percentage === 100) message = 'å®Œç¾ï¼å…¨éƒ¨ç­”å°ï¼ä½ å¤ªå²å®³äº†ï¼';
      else if (percentage >= 80) message = 'å¤ªæ£’äº†ï¼è¡¨ç¾å„ªç•°ï¼';
      else if (percentage >= 60) message = 'å¾ˆå¥½ï¼ç¹¼çºŒåŠ æ²¹ï¼';
      else message = 'ä¸éŒ¯ï¼å¤šç·´ç¿’æœƒæ›´å¥½ï¼';

      document.getElementById('scoreMessage').textContent = message;
      document.getElementById('endGameOverlay').classList.remove('hidden');

      speak(`éŠæˆ²çµæŸï¼ä½ ç²å¾—äº† ${goldStars} é¡†é‡‘æ˜Ÿæ˜Ÿï¼Œ${silverStars} é¡†éŠ€æ˜Ÿæ˜Ÿã€‚${message}`);
    }

    function restartGame() {
      document.getElementById('endGameOverlay').classList.add('hidden');
      gameState.currentRound = 0;
      gameState.stars = [];
      initStars();
      nextQuestion();
    }

    function backToHome() {
      document.getElementById('endGameOverlay').classList.add('hidden');
      showScreen('homeScreen');
    }

    function confirmBackToHome() {
      const confirmed = confirm('ç¢ºå®šè¦é›¢é–‹éŠæˆ²ä¸¦è¿”å›é¦–é å—ï¼Ÿç›®å‰é€²åº¦å°‡æœƒéºå¤±ã€‚');
      if (confirmed) {
        showScreen('homeScreen');
      }
    }

    // ==================== éŸ³æ•ˆ ====================
    function speak(text) {
      if ('speechSynthesis' in window) {
        speechSynthesis.cancel();
        const profile = voiceProfiles[gameConfig.voiceType] || voiceProfiles.normal;
        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = 'zh-TW';
        utterance.pitch = profile.pitch;
        utterance.rate = profile.rate;
        speechSynthesis.speak(utterance);
      }
    }

    function playSfx(type) {
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.connect(gain);
      gain.connect(ctx.destination);

      if (type === 'correct') {
        osc.frequency.value = 800;
        gain.gain.setValueAtTime(0.3, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.3);
      } else if (type === 'wrong') {
        osc.frequency.value = 200;
        gain.gain.setValueAtTime(0.2, ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
        osc.start(ctx.currentTime);
        osc.stop(ctx.currentTime + 0.2);
      }
    }

    // ==================== åˆå§‹åŒ– ====================
    window.addEventListener('load', () => {
      if ('speechSynthesis' in window) {
        speechSynthesis.getVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) {
          speechSynthesis.onvoiceschanged = () => speechSynthesis.getVoices();
        }
      }
      loadConfig();
    });
  </script>
</body>
</html>
